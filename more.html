<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NitePlay â€” Library</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="logo">NitePlay</div>
    <div class="tag">Premium late-night videos â€” click a thumbnail to watch</div>
  </header>

  <main class="container">
    <section id="gallery" class="gallery" aria-live="polite">
      <!-- cards injected here -->
    </section>
  </main>

  <!-- Modal player -->
  <div id="modal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-box" role="document">
      <div class="player">
        <video id="player" controls playsinline preload="metadata">
          <source id="playerSrc" src="" type="video/mp4">
          Your browser does not support HTML5 video.
        </video>
      </div>

      <div class="player-foot">
        <div id="pTitle" style="font-weight:700"></div>
        <div class="controls">
          <a id="downloadBtn" class="btn ghost" target="_blank" rel="noopener">â¬‡ Download</a>
          <button id="shareBtn" class="btn">ðŸ”— Share</button>
          <button id="closeBtn" class="btn">Close âœ–</button>
        </div>
      </div>

      <div class="ad-slot" id="adSlot">ðŸ”¥ Ad slot 300Ã—250 â€” replace with ad code later</div>
    </div>
  </div>

  <script>
    // load videos.json and render gallery
    async function loadGallery(){
      try {
        const res = await fetch('videos.json', {cache: "no-store"});
        if(!res.ok) throw new Error('videos.json not found');
        const videos = await res.json();
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = videos.map(v => `
          <article class="card" data-src="${encodeURI(v.src)}" data-title="${escapeHtml(v.title)}">
            <img loading="lazy" src="${v.thumbnail}" alt="${escapeHtml(v.title)}">
            <div class="info">
              <h3>${escapeHtml(v.title)}</h3>
              <p>${v.duration || ''}</p>
            </div>
          </article>
        `).join('');
        // attach click handlers
        document.querySelectorAll('.card').forEach(card => {
          card.addEventListener('click', ()=> openPlayer(card.dataset.src, card.dataset.title) );
        });
      } catch (err) {
        console.error(err);
        document.getElementById('gallery').innerHTML = '<p style="color:#ccc">Failed to load video list.</p>';
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }

    // Player modal logic
    const modal = document.getElementById('modal');
    const player = document.getElementById('player');
    const playerSrc = document.getElementById('playerSrc');
    const pTitle = document.getElementById('pTitle');
    const downloadBtn = document.getElementById('downloadBtn');
    const shareBtn = document.getElementById('shareBtn');
    const closeBtn = document.getElementById('closeBtn');

    function openPlayer(src, title){
      playerSrc.src = src;
      player.load();
      pTitle.textContent = title || 'Video';
      downloadBtn.href = src;
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      setTimeout(()=> player.play().catch(()=>{}), 120);
    }

    function closePlayer(){
      player.pause();
      playerSrc.src = '';
      player.load();
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
    }

    closeBtn.addEventListener('click', closePlayer);
    modal.addEventListener('click', e => { if(e.target === modal) closePlayer(); });
    document.addEventListener('keydown', e => { if(e.key === 'Escape' && modal.classList.contains('show')) closePlayer(); });

    // share/copy logic
    shareBtn.addEventListener('click', async ()=>{
      const url = playerSrc.src;
      if(navigator.share){
        try { await navigator.share({title: pTitle.textContent, url}); return; } catch(_) {}
      }
      try {
        await navigator.clipboard.writeText(url);
        alert('Link copied to clipboard');
      } catch(e){
        prompt('Copy this link', url);
      }
    });

    // start
    loadGallery();
  </script>
</body>
</html>